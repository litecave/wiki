
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>HvxKeysExecute - Free60 Wiki archive</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hvxkeysexecute" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Free60 Wiki archive" class="md-header__button md-logo" aria-label="Free60 Wiki archive" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Free60 Wiki archive
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              HvxKeysExecute
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Free60 Wiki archive" class="md-nav__button md-logo" aria-label="Free60 Wiki archive" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Free60 Wiki archive
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Hardware/" class="md-nav__link">
        Hardware
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_System_Software/" class="md-nav__link">
        System Software
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Homebrew_Software/" class="md-nav__link">
        Homebrew Software
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Linux/" class="md-nav__link">
        Linux
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Development/" class="md-nav__link">
        Development
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Support/" class="md-nav__link">
        Support
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../%21TODO/" class="md-nav__link">
        ToDo
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="hvxkeysexecute">HvxKeysExecute</h1>
<p>HvxKeysExecute is a syscall to execute a payload in privileged mode</p>
<ul>
<li>Microsoft uses it as a back door to xbox 360s</li>
<li>On retails: Payloads must be signed</li>
<li>On exploited consoles: Signature check must be patched</li>
</ul>
<p>Because this function has to do with online related services, I have
altered some function names, with the intention to reduce abusing this
for online purposes.</p>
<p>Why is this here if it has to do with online? Because while it is used
in the xbox live auth process, that does not appear to be its main
function. For example I have used it many times to help debug other HV
system calls.</p>
<pre><code class="language-cpp">#define KEYS_PARAMETER_FAIL 0xC8000030
#define KEYS_MAGIC_FAIL 0xC8000032
#define KEYS_HVMAGIC_FAIL 0xC8000033
#define KEYS_HEADER_FAIL 0xC8000034
#define KEYS_ENTRYPOINT_FAIL 0xC8000035
#define KEYS_CRYPT_FAIL 0xC8000036

// similar header to a bootloader, without the presets (probably because presets are passed as arguments)
typedef struct _BLHeader
{
    WORD Magic;     // 0 : 2
    WORD Version;       // 2 : 2
    DWORD Flags;        // 4 : 4
    DWORD EntryPoint;   // 8 : 4
    DWORD Size;     // 0xC : 4
    BYTE key[0x10];     // 0x10 : 0x10
    XECRYPT_SIG Sig;    // 0x20 : 0x100
    // Header: 0x120
}BLHeader, *PBLHeader;

BYTE BLKey[0x10] = { &lt;redacted&gt; };
BYTE ExSalt[0xA] = &lt;redacted&gt;; // NOTE: They use the same RSA key and BLKey as 1bl but different signature salt
XECRYPT_RSAPUB_2048 xRSA;
xRSA = &lt;redacted&gt;

typedef QWORD PayloadJump(PBYTE pbPayload, QWORD Arg1, QWORD Arg2, QWORD Arg3, QWORD Arg4);

QWORD HvxKeysExecute(PBYTE pbPayload, DWORD cbPayload, QWORD Arg1, QWORD Arg2, QWORD Arg3, QWORD Arg4)
{
    if(pbPayload &amp; 0x7F // 0x80 byte alignment check
        || cbPayload &amp; 0x7F // 0x80 byte alignment check
        || cbPayload &gt; 0x10000 // size check
        || (((pbPayload + cbPayload) - 1) ^ pbPayload) &amp; 0xFFFF0000)
        return KEYS_PARAMETER_FAIL;

    HvpAquireSpinLock(0x200016460);

    // our payload will be executed in realmode, to maintain security make sure it will be in a secure area
    DWORD origPayload = pbPayload;
    pbPayload = HvpRelocatePhysicalToInternal(pbPayload, cbPayload, 0x3E);

    // from now on if something fails, we need to invalidate the block in protected memory
    QWORD ret = 0;

    PBLHeader phPayload = (PBLHeader)pbPayload;
    if(phPayload-&gt;Magic &amp; 0xF0F == 0xD0D) // Payload Magic check
    {
        if((*(WORD*)0 ^ phPayload-&gt;Magic) &amp; 0xF000 == 0) // HV &amp; Payload magic check
        {
            if(phPayload-&gt;Size &gt;= 0x120 // sanity check
                || (phPayload-&gt;Size + 0xF) &amp; 0xFFFFFFF0 &gt;= phPayload-&gt;Size // ? dont see the point...?
                || (phPayload-&gt;Size + 0xF) &amp; 0xFFFFFFF0 &lt;= cbPayload) // sanity check
            {
                if(!phPayload-&gt;EntryPoint &amp; 3 // 4 byte alignment check
                    || phPayload-&gt;EntryPoint &gt;= 0x120 // sanity check
                    || phPayload-&gt;EntryPoint &lt;= phPayload-&gt;Size &amp; 0xFFFFFFFC) // sanity check
                {
                    BYTE rc4Key[0x10];
                    XeCryptHmacSha(BLKey, 0x10, &amp;phPayload-&gt;key, 0x10, 0, 0, 0, 0, rc4Key, 0x10);
                    XECRYPT_RC4_STATE rc4;
                    XeCryptRc4Key(&amp;rc4, rc4Key, 0x10);
                    XeCryptRc4Ecb(&amp;rc4, pbPayload+0x20, phPayload-&gt;Size - 0x20);
                    BYTE Hash[0x14];
                    XeCryptRotSumSha(pbPayload, 0x10, pbPayload+0x120, phPayload-&gt;Size - 0x120, Hash, 0x14);
                    if(XeCryptBnQwBeSigVerify(phPayload-&gt;Sig, Hash, ExSalt, &amp;xRSA))
                    {
                        // key and sig will not be used anymore, null them
                        *(QWORD*)pbPayload+0x10 = 0ull;
                        *(QWORD*)pbPayload+0x18 = 0ull;
                        memset(&amp;phPayload-&gt;Sig, 0, 0x100);
                        if(phPayload-&gt;Size &lt; cbPayload)
                            memset((pbPayload + phPayload-&gt;Size), 0, (cbPayload - phPayload-&gt;Size));

                        // jump to our payload
                        PayloadJump* pfPayload = (PayloadJump*)(pbPayload + phPayload-&gt;EntryPoint);
                        ret = pfPayload(pbPayload, Arg1, Arg2, Arg3, Arg4);
                    }
                    else ret = KEYS_CRYPT_FAIL;
                }
                else ret = KEYS_ENTRYPOINT_FAIL;
            }
            else ret = KEYS_HEADER_FAIL;
        }
        else ret = KEYS_HVMAGIC_FAIL;
    }
    else ret = KEYS_MAGIC_FAIL;

    BYTE retBuf[0x100];
    if(ret == 0) // assumed as success (payload return can change this)
        memcpy(retBuf, pbPayload+0x20, 0x100);
    else // assumed something failed, null retBuf (NOTE: if you want to use retBuf as a return buffer, payload must return 0)
        for(int i = 0;i &lt; 0x20;i++)
            retBuf[i*8] = 0ull;

    // clean up
    HvpInvalidateCachelines(pbPayload, cbPayload);
    pbPayload = HvpPhysicalToReal(origPayload, cbPayload);
    HvpZeroCacheLines(pbPayload, cbPayload &gt;&gt; 7);
    memcpy(pbPayload + 0x20, retBuf, 0x100);

    HvpReleaseSpinLock(0x200016460);

    return ret;
}
</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.febc23d1.min.js"></script>
      
    
  </body>
</html>