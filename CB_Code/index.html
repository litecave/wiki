
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>CB Code - Free60 Wiki archive</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cb-code" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Free60 Wiki archive" class="md-header__button md-logo" aria-label="Free60 Wiki archive" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Free60 Wiki archive
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              CB Code
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Free60 Wiki archive" class="md-nav__button md-logo" aria-label="Free60 Wiki archive" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Free60 Wiki archive
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Hardware/" class="md-nav__link">
        Hardware
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_System_Software/" class="md-nav__link">
        System Software
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Homebrew_Software/" class="md-nav__link">
        Homebrew Software
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Linux/" class="md-nav__link">
        Linux
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Xbox360_Development/" class="md-nav__link">
        Development
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Category_Support/" class="md-nav__link">
        Support
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../%21TODO/" class="md-nav__link">
        ToDo
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cb-dump" class="md-nav__link">
    CB Dump
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cb_a-pseudocode" class="md-nav__link">
    CB_A Pseudocode
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="cb-code">CB Code</h1>
<p>Some notes on the mfg version to start with:</p>
<ul>
<li>In the mfg version of the CB_A, the cpukey is set to null and
  XeCryptHmacSha is given the null buffer to generate the next key</li>
<li>Other than that there is no other change in the mfg version, boot
  process seems to continue as normal unless I'm overlooking a flag
  being set</li>
<li>It <em>seems</em> the mfg version is signed, which means we should be
  able to flash it to consoles without an issue and then we wouldn't
  have to worry about cpukeys for the cb at least. xebuild doesn't do
  that, I wonder why</li>
</ul>
<h2 id="cb-dump">CB Dump</h2>
<pre><code class="language-c">// BLKey = 1BL Key
// Hvx methods are meant to be proxies to read HV memory from user mode.
#define SPACE_NAND 0x80000200C8000000ULL

void getCB_AKey(PBYTE Keybuf)
{
    QWORD cbAddy = SPACE_NAND + Hvx::HvPeekDWORD(SPACE_NAND + 8);
    BYTE cbSalt[0x10];
    Hvx::HvPeekBytes(cbAddy+0x10, cbSalt, 0x10);
    XeCryptHmacSha(BLKey, 0x10, cbSalt, 0x10, 0, 0, 0, 0, Keybuf, 0x10);
}

void getCB_BKey(PBYTE Keybuf)
{
    DWORD cbOffs = Hvx::HvPeekDWORD(SPACE_NAND + 8);
    DWORD cbbOffs = cbOffs + (Hvx::HvPeekDWORD(SPACE_NAND + cbOffs + 0xC) + 0xF) &amp; 0xFFFFFFF0;
    QWORD cbbAddy = SPACE_NAND + cbbOffs;

    BYTE cbbSalt[0x10];
    BYTE cbKey[0x10];
    BYTE CPUKey[0x10];
    getCB_AKey(cbKey);
    getCPUKey(CPUKey);
    Hvx::HvPeekBytes(cbbAddy+0x10, cbbSalt, 0x10);
    XeCryptHmacSha(cbKey, 0x10, cbbSalt, 0x10, CPUKey, 0x10, 0, 0, Keybuf, 0x10);
}

void DumpCB_A()
{
    DbgOut(&quot;Dumping CB_A....\n&quot;);
    QWORD cbAddy = SPACE_NAND + Hvx::HvPeekDWORD(SPACE_NAND + 8);
    DWORD size = Hvx::HvPeekDWORD(cbAddy+0xC);
    printf(&quot;cbAddy: %016llX\nSize: %X\n&quot;, cbAddy, size);
    PBYTE cb = (PBYTE)XPhysicalAlloc(size, MAXULONG_PTR, NULL, PAGE_READWRITE);
    Hvx::HvPeekBytes(cbAddy, cb, size);
    CWriteFile(&quot;Hdd:\\cb_enc.bin&quot;, cb, size);

    BYTE rc4key[0x10];
    getCB_AKey(rc4key);
    XECRYPT_RC4_STATE rc4;
    XeCryptRc4Key(&amp;rc4, rc4key, 0x10);
    XeCryptRc4Ecb(&amp;rc4, cb + 0x20, size - 0x20);
    CWriteFile(&quot;Hdd:\\cb_dec.bin&quot;, cb, size);
    XPhysicalFree(cb);
}

void DumpCB_B()
{
    DbgOut(&quot;Dumping CB_B....\n&quot;);
    DWORD cbOffs = Hvx::HvPeekDWORD(SPACE_NAND + 8);
    DWORD cbbOffs = cbOffs + (Hvx::HvPeekDWORD(SPACE_NAND + cbOffs+0xC) + 0xF) &amp; 0xFFFFFFF0;
    QWORD cbbAddy = SPACE_NAND + cbbOffs;
    DWORD size = Hvx::HvPeekDWORD(cbbAddy + 0xC);
    printf(&quot;cbbOffs: 0x%08X\ncbbAddy: 0x%016llX\nSize: 0x%X\n&quot;, cbbOffs, cbbAddy, size);
    PBYTE cbb = (PBYTE)XPhysicalAlloc(size, MAXULONG_PTR, NULL, PAGE_READWRITE);
    Hvx::HvPeekBytes(cbbAddy, cbb, size);
    CWriteFile(&quot;Hdd:\\cbb_enc.bin&quot;, cbb, size);

    BYTE cbbKey[0x10];
    getCB_BKey(cbbKey);
    XECRYPT_RC4_STATE rc4;
    XeCryptRc4Key(&amp;rc4, cbbKey, 0x10);
    XeCryptRc4Ecb(&amp;rc4, cbb + 0x20, size - 0x20);
    CWriteFile(&quot;Hdd:\\cbb_dec.bin&quot;, cbb, size);
    XPhysicalFree(cbb);
}
</code></pre>
<h2 id="cb_a-pseudocode">CB_A Pseudocode</h2>
<p>Version: 9188 retail</p>
<pre><code class="language-c">// version: 0x23E4
// entry: 0x3C0
// size: 0x1AC0

// registers preset by the 1bl
// r27: not used
// r28: not used
// r29: not used
// r30: not used
// r31: next bl (cbb nand offset)
//          CB_A nand offset + CB_A size aligned to the upper 0x10 byte (ex: size = (size+0xF) &amp; 0xFFFFFFF0)

#define STACK   0x800002000001F700 // r1
#define TOC     0x800002000001C000 // r2
#define SRAM    0x8000020000010000
#define POSTo   0x8000020000061010
#define NAND    0x80000200C8000000
#define SOC     0x8000020000020000

// an attempt to make this easier to read
#define read64(addy) *(QWORD*)addy
#define read32(addy) *(DWORD*)addy
#define read16(addy) *(WORD*)addy
#define write64(addy, data) *(QWORD*)addy = data
#define write32(addy, data) *(DWORD*)addy = data
#define write16(addy, data) *(WORD*)addy = data

typedef struct _BLHeader
{
    WORD Magic;         // 0 : 2
    WORD Version;       // 2 : 2
    DWORD Flags;        // 4 : 4
    DWORD EntryPoint;   // 8 : 4
    DWORD Size;         // 0xC : 4
    BYTE key[0x10];     // 0x10 : 0x10
    QWORD Pad[4];       // 0x20 : 0x20
    // not used here? XECRYPT_SIG Sig;  // 0x40 : 0x100
    // Header: 0x140
}BLHeader, *PBLHeader;

void POST(BYTE postCode)
{
    write64(POSTo, (postCode &lt;&lt; 56));
}

void PanicGen()
{
    while(1)
        continue;
}

void Panic(QWORD postCode)
{
    POST(postCode);
    PanicGen();
}

bool VerifyOffset(DWORD offset, DWORD arg2)
{
    if(offset != (offset + 0xF) &amp; 0xFFFFFFF0)
        return false;
    if(offset - 0x80 &gt; 0x7FFFF7F)
        return false;
    if(arg2 &amp; 0xFFFFFFF0 &gt;= offset - 0x8000000)
        return false;
    return true;
}

// Copies by 0x10 byte blocks
// cBlocks: how many 0x10 byte blocks to copy
void CopyBy128(QWORD dest, QWORD src, DWORD cBlocks)
{
    for(int i = 0; i &lt; cBlocks; i++)
    {
        write64(dest+(i*0x10), read64(src+(i*0x10)));
        write64(dest+(i*0x10)+8, read64(src+(i*0x10)+8))
    }
}

void ZeroBy128(QWORD addy, QWORD count)
{
    for(int i = 0; i &lt; count; i++)
    {
        write64(addy+(i*0x10), 0ULL);
        write64(addy+(i*0x10)+8, 0ULL);
    }

}

QWORD getFuseline(DWORD fuse)
{
    if ((fuse * 0x40) &lt; 0x300)
        return read64(SOC + ((fuse * 0x40) &lt;&lt; 3));
    return 0;
}

void CBB_Jump(QWORD EntryPoint, QWORD NextBL)
{
    // presets for the next bootloader
    QWORD r27 = read64(SRAM + 0x20);
    QWORD r28 = read64(SRAM + 0x28);
    QWORD r29 = read64(SRAM + 0x30);
    QWORD r30 = read64(SRAM + 0x38);
    QWORD r31 = NextBL; // nand offset of the next bl

    // null the beginning of the cbb
    ZeroBy128(SRAM + 0x20, 0x12);

    DWORD tSize = (read32(SRAM + 0xC) + 0xF) &amp; 0xFFFFFFF0;
    if(tSize &gt; 0xC000)
        Panic(0xF3);

    // null the area after the cbb
    ZeroBy128(SRAM + tSize, (0xC000 - tSize) &gt;&gt; 4);

    // Sets r0-r26 and the CTR to 0

    // jump to cbb
    EntryPoint = (EntryPoint &amp; 0xFFFF) + 0x2000000;
    goto EntryPoint;
}

void CBB_Load(const QWORD offCBB, QWORD destCBB)
{
    // first null the stack
    for(int i = 0; i &lt; 0xB; i++)
        write64(stack-0x1A8+(i*8), 0ULL);

    POST(0xD1); // copy fuses for CBB decryption
    QWORD fuses[12] = { 0 };
    BYTE CPUKey[0x10] = { 0 };

    // if this is the mfg cb_a or a dev cb_a then the cpukey is set to 0
#ifdef RETAIL
    for(int i = 0; i &lt; 12; i++)
        getFuseline(i);
    QWORD fuse = fuses[3] | fuses[4]; // first CPUKey fuses
    write64(CPUKey, fuse);
    fuse = fuses[5] | fuses[6]; // second CPUKey fuses
    write64(CPUKey+8, fuse);
#endif

    POST(0xD2); // verify CBB offset
    DWORD cbbOffset = offCBB &amp; 0xFFFFFFFF; // r28
    if(!VerifyOffset(cbbOffset, 0x10))
        Panic(0xF0);

    POST(0xD3); // copy cbb header to sram
    QWORD cbbAddy = NAND + cbbOffset;
    CopyBy128(destCBB, cbbAddy, 1);

    POST(0xD4); // verify header
    PBLHeader cbbHeader = (PBLHeader)destCBB;
    if((cbbHeader-&gt;Size - 0x3C0) &gt; 0xBC40 // size check
        || cbbHeader-&gt;Magic != read64(TOC) &amp; 0xFFFF // magic check
        || cbbHeader-&gt;EntryPoint &amp; 0x3 // alignment check
        || cbbHeader-&gt;EntryPoint &lt; 0x3C0 // EntryPoint check
        || cbbHeader-&gt;EntryPoint &gt;= cbbHeader-&gt;Size &amp; 0xFFFFFFFC // entrypoint/size relation check
        || !VerifyOffset(cbbOffset, cbbHeader-&gt;Size))
        Panic(0xF1);

    POST(0xD5); // copy cbb to SRAM
    QWORD tSize = (cbbHeader-&gt;Size + 0xF) &amp; 0xFFFFFFF0;
    CopyBy128(destCBB + 0x10, cbbAddy + 0x10, ((tSize - 0x10) &gt;&gt; 4) &amp; 0xFFFFFFFF);

    POST(0xD6); // Gen cbb key
    // cbb key = hmacsha of the cb_a key, cb_b salt, and CPUKey
    XeCryptHmacSha(TOC+0x10, 0x10, &amp;cbbHeader-&gt;key, 0x10, CPUKey, 0x10, 0, 0, &amp;cbbHeader-&gt;key, 0x10);

    POST(0xD7); // set key
    XECRYPT_RC4_STATE rc4;
    XeCryptRc4Key(&amp;rc4, &amp;cbbHeader-&gt;key, 0x10);

    POST(0xD8); // decrypt cbb
    XeCryptRc4Ecb(&amp;rc4, SRAM+0x20, tSize-0x20);

    POST(0xD9); // generate hash
    BYTE Hash[0x14] = { 0 };
    XeCryptRotSumSha(SRAM, 0x10, SRAM+0x140, tSize-0x140, Hash, 0x14);

    POST(0xDA); // verify integrity
    if(memcmp(Hash, TOC+0x39C, 0x14))
        Panic(0xF2);

    POST(0xDB); // jump to cbb
    write16(SRAM+6, read16(SRAM+6)); // copy flags
    CBB_Jump(cbbHeader-&gt;EntryPoint, tSize+offCBB);
    return;
}

void CBA_Main()
{
    // registers 27-31 are preset by the 1bl opon entry
    POST(0xD0); // CB_A entry, copy self to 0x800002000001C000 and continue from there
    DWORD size = *(QWORD*)SRAM+0xC;
    size = (size+0xF) &gt;&gt; 3;
    for(int i = 0; i &lt; size; i++)
        write64(TOC+(i*8), read64(SRAM+(i*8)));

    // from now on we're executing from 0x800002000001C000
    CBB_Load(r31, SRAM);
}
</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.febc23d1.min.js"></script>
      
    
  </body>
</html>